<!doctype html>
<html lang="en" class="antialiased">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SignAura: ISL NMF Translator</title>

  <!-- Google Font: Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <!-- Tailwind Play CDN for prototype (no build step) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Tailwind config (extend theme)
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'ui-sans-serif', 'system-ui', 'sans-serif']
          },
          colors: {
            brand: {
              50: '#eef2ff',
              100: '#e0e7ff',
              500: '#6366f1',
              700: '#4f46e5'
            }
          },
        }
      }
    }
  </script>

  <style>
    /* Enhanced glowing translation text */
    .glow-text-enhanced {
      text-shadow: 
        0 0 10px rgba(255, 255, 255, 0.8),
        0 0 20px rgba(199, 210, 254, 0.6),
        0 0 30px rgba(165, 180, 252, 0.4),
        0 2px 4px rgba(0, 0, 0, 0.3);
      filter: drop-shadow(0 4px 12px rgba(255, 255, 255, 0.2));
    }
    
    /* Smooth text transition with fade */
    .text-transition {
      transition: 
        opacity 300ms cubic-bezier(0.4, 0, 0.2, 1),
        transform 300ms cubic-bezier(0.4, 0, 0.2, 1),
        filter 300ms ease;
    }
    
    /* Fade-in animation for new text */
    @keyframes fadeInGlow {
      0% {
        opacity: 0;
        transform: translateY(8px) scale(0.95);
        filter: blur(4px);
      }
      100% {
        opacity: 1;
        transform: translateY(0) scale(1);
        filter: blur(0);
      }
    }
    
    .text-appear {
      animation: fadeInGlow 400ms cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    
    /* smooth transitions for translation box */
    .translation-transition {
      transition: opacity 200ms ease;
    }
    
    /* scroll fade for transcript */
    .transcript-scroll {
      scrollbar-width: thin;
    }
    
    /* pulse animation for record button */
    @keyframes pulse-glow {
      0%, 100% {
        box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7);
      }
      50% {
        box-shadow: 0 0 0 8px rgba(99, 102, 241, 0);
      }
    }
    .pulse-active {
      animation: pulse-glow 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    /* glow effect for high-value progress bars */
    .bar-glow[data-high="true"] {
      box-shadow: 0 0 12px currentColor, 0 0 6px currentColor;
      filter: brightness(1.2);
    }
    .bar-glow {
      transition: box-shadow 0.3s ease, filter 0.3s ease, width 0.3s ease-out;
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-slate-900 dark:text-slate-100">
  <!-- Top navigation -->
  <header class="bg-white/60 dark:bg-slate-800/60 backdrop-blur sticky top-0 z-30 border-b border-slate-200 dark:border-slate-700">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <div class="flex items-center gap-3">
          <div class="w-9 h-9 rounded-md bg-gradient-to-tr from-indigo-600 to-blue-500 flex items-center justify-center text-white shadow-md">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M12 2L19 8v8l-7 6-7-6V8l7-6z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
          </div>
          <div>
            <div class="text-lg font-semibold">SignAura</div>
            <div class="text-xs text-slate-500 dark:text-slate-400">ISL NMF Translator</div>
          </div>
        </div>

        <div class="flex items-center gap-3">
          <nav class="hidden md:flex items-center gap-2 text-sm text-slate-600 dark:text-slate-300">
            <a class="px-3 py-2 rounded hover:bg-slate-100 dark:hover:bg-slate-700 transition" href="#">Dashboard</a>
            <a class="px-3 py-2 rounded hover:bg-slate-100 dark:hover:bg-slate-700 transition" href="#">Dataset</a>
            <a class="px-3 py-2 rounded hover:bg-slate-100 dark:hover:bg-slate-700 transition" href="#">Settings</a>
          </nav>

          <div class="flex items-center gap-2">
            <button id="darkToggle" class="p-2 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700 transition" title="Toggle dark">
              <svg id="darkIcon" class="w-5 h-5 text-slate-600 dark:text-slate-200" viewBox="0 0 24 24" fill="none">
                <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
            <button id="snapshotBtn" class="px-3 py-1.5 bg-indigo-600 text-white rounded-md shadow hover:bg-indigo-700 transition">Snapshot</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Main content -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
      <!-- Left: Webcam preview -->
      <section class="lg:col-span-7">
        <div class="flex flex-col gap-4">
          <div class="rounded-2xl bg-white dark:bg-slate-800 shadow-lg overflow-hidden border border-slate-200 dark:border-slate-700">
            <div class="p-4 flex items-center justify-between border-b border-slate-100 dark:border-slate-700">
              <h3 class="text-sm font-medium">Live Camera</h3>
              <div class="text-xs text-slate-500 dark:text-slate-400">Preview â€¢ 640Ã—480</div>
            </div>

            <div class="p-6 flex items-center justify-center relative">
              <!-- video element for app.js to attach to -->
              <div class="bg-slate-900/5 dark:bg-slate-700/30 rounded-lg shadow-inner relative">
                <video id="video" autoplay playsinline muted width="640" height="480" class="block rounded-lg w-[640px] h-[480px] object-cover bg-black"></video>
                <canvas id="overlay" width="640" height="480" class="absolute top-0 left-0 rounded-lg pointer-events-none"></canvas>
              </div>
            </div>

            <div class="p-4 border-t border-slate-100 dark:border-slate-700 flex items-center justify-between gap-4">
              <div class="flex items-center gap-3 text-sm">
                <div class="text-slate-600 dark:text-slate-400">Status:</div>
                <div id="cameraStatus" class="px-2 py-0.5 rounded bg-emerald-100 text-emerald-800 text-xs dark:bg-emerald-900/30 dark:text-emerald-300">Initializingâ€¦</div>
              </div>
            </div>
          </div>

          <!-- Control Panel -->
          <div class="rounded-2xl bg-white dark:bg-slate-800 shadow-lg p-5 border border-slate-200 dark:border-slate-700">
            <h3 class="text-sm font-medium mb-4">Camera Controls</h3>
            
            <!-- Camera control buttons -->
            <div class="flex items-center gap-3 mb-4">
              <button id="btnStart" class="flex items-center gap-2 px-4 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 active:bg-emerald-800 transition shadow-sm hover:shadow">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span class="font-medium">Start Camera</span>
              </button>

              <button id="btnStop" class="flex items-center gap-2 px-4 py-2 rounded-lg bg-rose-600 text-white hover:bg-rose-700 active:bg-rose-800 transition shadow-sm hover:shadow disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"/>
                </svg>
                <span class="font-medium">Stop</span>
              </button>

              <button id="btnRecord" class="flex items-center gap-2 px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 active:bg-indigo-800 transition shadow-sm hover:shadow disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span class="font-medium">Record Sample</span>
              </button>
            </div>

            <!-- Label selection and export -->
            <div class="flex items-center gap-3 pt-3 border-t border-slate-100 dark:border-slate-700">
              <label for="labelSelect" class="text-sm font-medium text-slate-600 dark:text-slate-400">Label:</label>
              <select id="labelSelect" class="flex-1 px-3 py-2 text-sm rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-100 focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition">
                <option value="neutral">Neutral</option>
                <option value="question">Question</option>
                <option value="affirm">Affirm</option>
                <option value="surprise">Surprise</option>
                <option value="negation">Negation</option>
              </select>

              <button id="btnExport" class="flex items-center gap-2 px-4 py-2 rounded-lg bg-slate-600 text-white hover:bg-slate-700 active:bg-slate-800 transition shadow-sm hover:shadow">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                </svg>
                <span class="font-medium text-sm">Export Dataset</span>
              </button>
            </div>
          </div>

          <!-- small help / hint -->
          <div class="text-sm text-slate-500 dark:text-slate-400">
            Tip: Allow camera access. The translation box updates as non-manual features are detected.
          </div>
        </div>
      </section>

      <!-- Right: Info panel -->
      <aside class="lg:col-span-5">
        <div class="flex flex-col gap-5">
          <!-- Translation box -->
          <div class="rounded-2xl bg-gradient-to-br from-indigo-600/90 to-blue-500/90 dark:from-indigo-700/90 dark:to-blue-600/90 backdrop-blur-xl border border-white/20 dark:border-white/10 text-white shadow-2xl p-8 translation-transition relative overflow-hidden">
            <!-- Glassmorphism overlay -->
            <div class="absolute inset-0 bg-gradient-to-br from-white/10 to-transparent pointer-events-none"></div>
            
            <div class="relative z-10">
              <div class="flex items-center justify-between mb-3">
                <div class="text-xs uppercase tracking-wider opacity-90 font-medium">Current interpretation</div>
                <div class="text-sm text-indigo-100/90">
                  <div id="translationConfidence" class="text-right font-medium">live</div>
                </div>
              </div>
              
              <div class="min-h-[120px] flex items-center justify-center">
                <h2 id="nmfText" class="text-3xl md:text-4xl lg:text-5xl font-bold text-center glow-text-enhanced text-transition leading-tight">ðŸ‘† Click "Start Camera" to begin</h2>
              </div>
            </div>
          </div>

          <!-- Live Feature Monitoring Panel -->
          <div class="rounded-2xl bg-white dark:bg-slate-800 shadow-lg p-5 border border-slate-200 dark:border-slate-700">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-sm font-medium">Live Feature Monitoring</h3>
              <div class="text-xs text-slate-500 dark:text-slate-400">Real-time</div>
            </div>

            <div class="space-y-4">
              <!-- Eye Openness -->
              <div class="space-y-1.5">
                <div class="flex items-center justify-between text-xs">
                  <span class="text-slate-600 dark:text-slate-400 font-medium">Eye Openness</span>
                  <span id="barEyeValue" class="text-slate-500 dark:text-slate-500 font-mono">0%</span>
                </div>
                <div class="h-2 bg-slate-100 dark:bg-slate-700/50 rounded-full overflow-hidden">
                  <div id="barEye" class="h-full bg-gradient-to-r from-emerald-500 to-emerald-400 rounded-full transition-all duration-300 ease-out bar-glow" style="width: 0%"></div>
                </div>
              </div>

              <!-- Brow Raise -->
              <div class="space-y-1.5">
                <div class="flex items-center justify-between text-xs">
                  <span class="text-slate-600 dark:text-slate-400 font-medium">Brow Raise</span>
                  <span id="barBrowValue" class="text-slate-500 dark:text-slate-500 font-mono">0%</span>
                </div>
                <div class="h-2 bg-slate-100 dark:bg-slate-700/50 rounded-full overflow-hidden">
                  <div id="barBrow" class="h-full bg-gradient-to-r from-amber-500 to-amber-400 rounded-full transition-all duration-300 ease-out bar-glow" style="width: 0%"></div>
                </div>
              </div>

              <!-- Mouth Open -->
              <div class="space-y-1.5">
                <div class="flex items-center justify-between text-xs">
                  <span class="text-slate-600 dark:text-slate-400 font-medium">Mouth Open</span>
                  <span id="barMouthValue" class="text-slate-500 dark:text-slate-500 font-mono">0%</span>
                </div>
                <div class="h-2 bg-slate-100 dark:bg-slate-700/50 rounded-full overflow-hidden">
                  <div id="barMouth" class="h-full bg-gradient-to-r from-rose-500 to-rose-400 rounded-full transition-all duration-300 ease-out bar-glow" style="width: 0%"></div>
                </div>
              </div>

              <!-- Head Roll -->
              <div class="space-y-1.5">
                <div class="flex items-center justify-between text-xs">
                  <span class="text-slate-600 dark:text-slate-400 font-medium">Head Roll</span>
                  <span id="barRollValue" class="text-slate-500 dark:text-slate-500 font-mono">0Â°</span>
                </div>
                <div class="h-2 bg-slate-100 dark:bg-slate-700/50 rounded-full overflow-hidden">
                  <div id="barRoll" class="h-full bg-gradient-to-r from-blue-500 to-blue-400 rounded-full transition-all duration-300 ease-out bar-glow" style="width: 50%"></div>
                </div>
              </div>

              <!-- Nod -->
              <div class="space-y-1.5">
                <div class="flex items-center justify-between text-xs">
                  <span class="text-slate-600 dark:text-slate-400 font-medium">Nod</span>
                  <span id="barNodValue" class="text-slate-500 dark:text-slate-500 font-mono">0%</span>
                </div>
                <div class="h-2 bg-slate-100 dark:bg-slate-700/50 rounded-full overflow-hidden">
                  <div id="barNod" class="h-full bg-gradient-to-r from-purple-500 to-purple-400 rounded-full transition-all duration-300 ease-out bar-glow" style="width: 0%"></div>
                </div>
              </div>

              <!-- Torso Lean -->
              <div class="space-y-1.5">
                <div class="flex items-center justify-between text-xs">
                  <span class="text-slate-600 dark:text-slate-400 font-medium">Torso Lean</span>
                  <span id="barTorsoValue" class="text-slate-500 dark:text-slate-500 font-mono">0%</span>
                </div>
                <div class="h-2 bg-slate-100 dark:bg-slate-700/50 rounded-full overflow-hidden">
                  <div id="barTorso" class="h-full bg-gradient-to-r from-indigo-500 to-indigo-400 rounded-full transition-all duration-300 ease-out bar-glow" style="width: 0%"></div>
                </div>
              </div>
            </div>

            <div class="mt-4 pt-3 border-t border-slate-100 dark:border-slate-700 text-xs text-slate-500 dark:text-slate-400 text-center">
              Bars glow when features exceed thresholds
            </div>
          </div>

          <!-- Features cards -->
          <div class="rounded-2xl bg-white dark:bg-slate-800 shadow-lg p-4 border border-slate-200 dark:border-slate-700">
            <h3 class="text-sm font-medium mb-3">Detected features</h3>

            <div id="featuresGrid" class="grid grid-cols-2 gap-3">
              <!-- Feature card template (populated by JS) -->
              <div class="p-3 bg-slate-50 dark:bg-slate-900/40 border border-slate-100 dark:border-slate-700 rounded-lg">
                <div class="text-xs text-slate-500 dark:text-slate-400">Eye ratio</div>
                <div id="f-eye" class="mt-1 text-lg font-semibold">â€”</div>
              </div>

              <div class="p-3 bg-slate-50 dark:bg-slate-900/40 border border-slate-100 dark:border-slate-700 rounded-lg">
                <div class="text-xs text-slate-500 dark:text-slate-400">Brow</div>
                <div id="f-brow" class="mt-1 text-lg font-semibold">â€”</div>
              </div>

              <div class="p-3 bg-slate-50 dark:bg-slate-900/40 border border-slate-100 dark:border-slate-700 rounded-lg">
                <div class="text-xs text-slate-500 dark:text-slate-400">Mouth</div>
                <div id="f-mouth" class="mt-1 text-lg font-semibold">â€”</div>
              </div>

              <div class="p-3 bg-slate-50 dark:bg-slate-900/40 border border-slate-100 dark:border-slate-700 rounded-lg">
                <div class="text-xs text-slate-500 dark:text-slate-400">Nod</div>
                <div id="f-nod" class="mt-1 text-lg font-semibold">â€”</div>
              </div>

              <div class="p-3 bg-slate-50 dark:bg-slate-900/40 border border-slate-100 dark:border-slate-700 rounded-lg">
                <div class="text-xs text-slate-500 dark:text-slate-400">Roll</div>
                <div id="f-roll" class="mt-1 text-lg font-semibold">â€”</div>
              </div>

              <div class="p-3 bg-slate-50 dark:bg-slate-900/40 border border-slate-100 dark:border-slate-700 rounded-lg">
                <div class="text-xs text-slate-500 dark:text-slate-400">Torso</div>
                <div id="f-torso" class="mt-1 text-lg font-semibold">â€”</div>
              </div>
            </div>

            <div class="mt-4 flex items-center gap-3">
              <button id="copyTranslation" class="px-3 py-1 rounded bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 transition text-sm">Copy</button>
              <button id="speakBtn" class="px-3 py-1 rounded bg-indigo-600 text-white hover:bg-indigo-700 transition text-sm">Speak</button>
              <div class="ml-auto text-xs text-slate-500 dark:text-slate-400">Live</div>
            </div>
          </div>

          <!-- Transcript -->
          <div class="rounded-2xl bg-white dark:bg-slate-800 shadow-lg p-4 border border-slate-200 dark:border-slate-700">
            <div class="flex items-center justify-between">
              <h3 class="text-sm font-medium">Transcript</h3>
              <div class="flex items-center gap-2">
                <button id="exportBtn" class="px-2 py-0.5 rounded text-sm bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 transition">Export</button>
                <button id="clearBtn" class="px-2 py-0.5 rounded text-sm bg-rose-50 text-rose-700 hover:bg-rose-100 transition dark:bg-rose-900/30 dark:text-rose-300">Clear</button>
                <button id="downloadDataBtn" class="px-2 py-0.5 rounded text-sm bg-indigo-100 text-indigo-700 hover:bg-indigo-200 transition dark:bg-indigo-900/30 dark:text-indigo-300">Download Dataset</button>
              </div>
            </div>

            <div id="transcriptLog" class="mt-3 max-h-48 overflow-auto transcript-scroll space-y-2">
              <!-- entries appended here -->
              <div class="text-sm text-slate-400">No entries yet.</div>
            </div>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <!-- Minimal JS UI API -->
  <script>
    (function () {
      // Wait for DOM to be fully loaded before initializing
      document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing SignAuraUI...');
        
        // Simple UI bridge to be called by your detection code.
        const ui = {
          elems: {
            video: document.getElementById('video'),
            overlay: document.getElementById('overlay'),
            cameraStatus: document.getElementById('cameraStatus'),
            fEye: document.getElementById('f-eye'),
            fBrow: document.getElementById('f-brow'),
            fMouth: document.getElementById('f-mouth'),
            fNod: document.getElementById('f-nod'),
            fRoll: document.getElementById('f-roll'),
            fTorso: document.getElementById('f-torso'),
            nmfText: document.getElementById('nmfText'),
            translationConfidence: document.getElementById('translationConfidence'),
            transcriptLog: document.getElementById('transcriptLog'),
            darkToggle: document.getElementById('darkToggle'),
            snapshotBtn: document.getElementById('snapshotBtn'),
            copyTranslation: document.getElementById('copyTranslation'),
            speakBtn: document.getElementById('speakBtn'),
            exportBtn: document.getElementById('exportBtn'),
            clearBtn: document.getElementById('clearBtn'),
            downloadDataBtn: document.getElementById('downloadDataBtn'),
            // New control panel elements
            btnStart: document.getElementById('btnStart'),
            btnStop: document.getElementById('btnStop'),
            btnRecord: document.getElementById('btnRecord'),
            labelSelect: document.getElementById('labelSelect'),
            btnExport: document.getElementById('btnExport'),
          },
        state: {
          transcript: [],
          dark: false,
          cameraRunning: false,
          recording: false
        },
        // Format number or show placeholder
        _fmt(n) {
          if (n === undefined || n === null || Number.isNaN(n)) return 'â€”';
          return (Math.round(n * 1000) / 1000).toString();
        },
        updateCameraStatus(text, cls) {
          const el = this.elems.cameraStatus;
          el.textContent = text;
          // optional class updates
        },
        updateFeatures(obj = {}) {
          // Expect keys: eye, brow, mouth, roll, nod, torso (and any extras)
          this.elems.fEye.textContent = this._fmt(obj.eye);
          this.elems.fBrow.textContent = this._fmt(obj.brow);
          this.elems.fMouth.textContent = this._fmt(obj.mouth);
          this.elems.fRoll.textContent = this._fmt(obj.roll);
          this.elems.fNod.textContent = this._fmt(obj.nod);
          this.elems.fTorso.textContent = this._fmt(obj.torso);
        },
        setTranslation(text = 'â€”', meta = {}) {
          // apply enhanced fade and glow animation
          const el = this.elems.nmfText;
          
          // Remove previous animation class if present
          el.classList.remove('text-appear');
          
          // Trigger reflow to restart animation
          void el.offsetWidth;
          
          // Fade out briefly
          el.style.opacity = '0';
          el.style.transform = 'translateY(4px)';
          
          setTimeout(() => {
            el.textContent = text || 'â€”';
            
            // Add appear animation
            el.classList.add('text-appear');
            el.style.opacity = '';
            el.style.transform = '';
            
            // Remove animation class after completion
            setTimeout(() => {
              el.classList.remove('text-appear');
            }, 400);
          }, 150);
          
          if (meta.confidence) {
            this.elems.translationConfidence.textContent = `Confidence: ${Math.round(meta.confidence*100)}%`;
          } else {
            this.elems.translationConfidence.textContent = 'live';
          }
        },
        addTranscriptEntry(text) {
          const time = new Date().toLocaleTimeString();
          // remove placeholder if present
          if (this.state.transcript.length === 0 && this.elems.transcriptLog.children.length === 1) {
            const only = this.elems.transcriptLog.children[0];
            if (only && only.textContent && only.textContent.includes('No entries')) {
              this.elems.transcriptLog.innerHTML = '';
            }
          }

          const entry = document.createElement('div');
          entry.className = 'flex items-start gap-3 p-2 rounded hover:bg-slate-50 dark:hover:bg-slate-700 transition';
          entry.innerHTML = `
            <div class="text-xs text-slate-400 dark:text-slate-500 w-16">${time}</div>
            <div class="text-sm">${text}</div>
          `;
          // prepend (newest first)
          this.elems.transcriptLog.prepend(entry);
          this.state.transcript.unshift({ time: Date.now(), text });
          // cap transcript to 200 entries in UI and state
          if (this.state.transcript.length > 200) {
            this.state.transcript.pop();
            if (this.elems.transcriptLog.children.length > 200) {
              this.elems.transcriptLog.removeChild(this.elems.transcriptLog.lastChild);
            }
          }
        },
        snapshot() {
          const v = this.elems.video;
          if (!v || v.readyState < 2) return alert('Camera not ready');
          const c = document.createElement('canvas');
          c.width = v.videoWidth || 640;
          c.height = v.videoHeight || 480;
          c.getContext('2d').drawImage(v, 0, 0, c.width, c.height);
          const data = c.toDataURL('image/png');
          const a = document.createElement('a');
          a.href = data;
          a.download = `signaura-snapshot-${Date.now()}.png`;
          a.click();
        },
        copyTranslationToClipboard() {
          const txt = this.elems.nmfText.textContent || '';
          navigator.clipboard?.writeText(txt);
        },
        speakTranslation() {
          const txt = this.elems.nmfText.textContent || '';
          if (!('speechSynthesis' in window)) return;
          const ut = new SpeechSynthesisUtterance(txt);
          ut.lang = 'en-US';
          speechSynthesis.cancel();
          speechSynthesis.speak(ut);
        },
        exportTranscriptCSV() {
          const rows = [['timestamp', 'text']];
          this.state.transcript.slice().reverse().forEach(item => {
            rows.push([new Date(item.time).toISOString(), item.text.replace(/\n/g, ' ')]);
          });
          const csv = rows.map(r => r.map(c => `"${(c+'').replace(/"/g,'""')}"`).join(',')).join('\n');
          const blob = new Blob([csv], { type: 'text/csv' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'signaura-transcript.csv';
          a.click();
          URL.revokeObjectURL(url);
        },
        clearTranscript() {
          this.state.transcript = [];
          this.elems.transcriptLog.innerHTML = '<div class="text-sm text-slate-400">No entries yet.</div>';
        },
        toggleDark() {
          this.state.dark = !this.state.dark;
          document.documentElement.classList.toggle('dark', this.state.dark);
        },
        setRecording(active) {
          this.state.recording = active;
          if (active) {
            this.elems.btnRecord.classList.add('pulse-active');
          } else {
            this.elems.btnRecord.classList.remove('pulse-active');
          }
        },
        setCameraRunning(running) {
          this.state.cameraRunning = running;
          this.elems.btnStart.disabled = running;
          this.elems.btnStop.disabled = !running;
          this.elems.btnRecord.disabled = !running;
        },
      };

      // wire UI controls
      ui.elems.darkToggle.addEventListener('click', () => {
        ui.toggleDark();
      });
      ui.elems.snapshotBtn.addEventListener('click', () => ui.snapshot());
      ui.elems.copyTranslation.addEventListener('click', () => ui.copyTranslationToClipboard());
      ui.elems.speakBtn.addEventListener('click', () => ui.speakTranslation());
      ui.elems.exportBtn.addEventListener('click', () => ui.exportTranscriptCSV());
      ui.elems.clearBtn.addEventListener('click', () => ui.clearTranscript());

      // expose simple API
      window.SignAuraUI = {
        updateFeatures: (f) => ui.updateFeatures(f),
        setTranslation: (text, meta) => {
          ui.setTranslation(text, meta || {});
        },
        addTranscriptEntry: (t) => ui.addTranscriptEntry(t),
        copyTranslation: () => ui.copyTranslationToClipboard(),
        exportTranscript: () => ui.exportTranscriptCSV(),
        clearTranscript: () => ui.clearTranscript(),
        toggleDarkMode: () => ui.toggleDark(),
        setCameraStatus: (s) => ui.updateCameraStatus(s),
        setRecording: (active) => ui.setRecording(active),
        setCameraRunning: (running) => ui.setCameraRunning(running),
        // for direct element access if needed
        elems: ui.elems,
        state: ui.state,
      };

      // initial dark state sync with prefers-color-scheme
      if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        ui.state.dark = true;
        document.documentElement.classList.add('dark');
      }
      
      console.log('âœ… SignAuraUI initialized successfully');
      console.log('Control panel elements:', {
        btnStart: ui.elems.btnStart,
        btnStop: ui.elems.btnStop,
        btnRecord: ui.elems.btnRecord
      });
    }); // End DOMContentLoaded
    })();
  </script>

  <!-- MediaPipe scripts (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
  <script src="app.js?v=5"></script>
</body>
</html>
